# Changelog

----------------------------------------------------------------------------------------

## 0.0.11 (Upcoming)

### Added
- Added new module `msreport.imputer`, which includes a number of classes for various
  imputation strategies. To apply a particular imputation strategy, an `Imputer` object
  can be passed to `msreport.analyze.impute_missing_values()` together with a qtable.
- Added `msreport.imputer.FixedValueImputer`. The `FixedValueImputer` can be used with
  on of two different imputation strategies: either to replace missing values with a
  user defined fixed value (strategy="constant") or to replace missing values with a
  value that is smaller than the lowest observed value (strategy="below").
- Added `msreport.imputer.GaussianImputer`, which allows replacing missing values by
  drawing values from a gaussian distribution with specified mu and sigma.
- Added `msreport.imputer.PerseusImputer`, which is an implementation of the
  Perseus-style imputation. Missing values are replaced by drawing values from a
  gaussian distribution, which parameters are calculated using the standard deviation
  and median of the observed values.
- Added `msreport.helper.apply_intensity_cutoff()` function for replacing intensity
  values below a specified threshold with NaN.
- Made relevant msreport submodules available by importing `msreport`, so they don't
  need to be imported separately: `reader`, `normalize`, `impute`, `analyze`, `plot`,
  and `export`
- The `msreport.reader.SpectronautReader` can now also be accessed via
  `msreport.SpectronautReader`, similar as for the other reader classes.

### Changed
- (!) Changed the interface of `msreport.analyze.impute_missing_values()`. Instead of
  performing a Perseus-style imputation, `impute_missing_values()` now takes an
  `Imputer` object as input, which specifies the imputation strategy that is used to
  replace missing values. The new interface allows to add new imputation strategies by
  creating additional `Imputer` classes, without requiring additional changes to the
  `impute_missing_values()` interface.
- (!) Changed the interface of `msreport.analyze.normalize_expression()`. Instead of
  specifying the normalization method with a keyword `impute_missing_values()` now takes
  an `Normalizer` object as input, which specifies the normalization strategy that is
  used. The changed interface of `normalize_expression()` is identical to the new 
  interface of `impute_missing_values()`.

### Fixed
- Added missing "Intensity" columns to amica tables exported from qtable.
- Fixed negative iBAQ intensities, which were caused by calculation of iBAQ intensities
  with negative iBAQ peptides. Negative or zero iBAQ peptides now results in iBAQ
  intensities being reported as NaN.
  - This also fixes the issue of all iBAQ intensities being zero when calling
    `add_ibaq_intensities` with `normlize=True` in the presence of negative iBAQ peptide
    entries.

----------------------------------------------------------------------------------------

## 0.0.10 - Fix annotated scatter plot issues

### Changed
- Added minimal version for seaborn library (>= 0.12.0)

### Fixed
- Error that might occur when using `plot.expression_comparison()` and for any suplot
  no special protein is specified for annotation.
- Add missing y-label in the expression comparison plot
- Annotation of wrong data points in scatter plots when using seaborn version < 0.12.0 

----------------------------------------------------------------------------------------

## 0.0.9 - SpectronautReader for LFQ protein reports

### Added
- A prototype reader for Spectronaut has been added. The `reader.SpectronautReader`
  class currently supports import of DIA LFQ protein reports and Spectronaut
  "ConditionSetup" files.
- Added `helper.rename_sample_columns()` for cautious renaming sample names that appear
  as substring of dataframe columns.
- Added `helper.import_protein_database()` to replace `helper.importProteinDatabase()`.
- Added `sort_by` argument to `msreport_scripts.proteins.write_protein_report()` which
  can be used to specify by which column the Excel table is sorted.

### Changed
- The "Replicate" column has been made mandatory in the `Qtable` experimental design.
- The "Raw files" column has been changed to "Filename" in the "Info" tab of the Excel
  report generated by `msreport_scripts.proteins.write_protein_report()`.

### Fixed
- The default `tag` parameter in `plot.sample_pca()` should have been "Expression" and
  not "Intensity".
- Unequal bar size in several plots when a different number of samples or experiments
  were plotted.
- X-axis boundaries in `plot.expression_comparison()` were displaced by adding special
  protein annotations.
- Error when using `plot.expression_comparison()` to plot data with no missing values. 

### Deprecated
- `helper.importProteinDatabase()` will be removed in the future.

----------------------------------------------------------------------------------------

## 0.0.8 - Analyze functions exclude invalid by default

### Added
- Added `exclude_invalid` parameter to `analyze.impute_missing_values()`.
- Added `analyze.calculate_multi_group_comparison()` for calculation of ratios and 
  average expression for multiple pair wise experiment comparisons.

### Changed
- Default behavior of `analyze.impute_missing_values()` is now to impute missing values
  only for valid rows.
- Default behavior of `analyze.two_group_comparison()` is now to calculate values only
  for valid rows.

----------------------------------------------------------------------------------------

## 0.0.7 - More and better plots

### Added
- Added new plot `plot.pvalue_histogram()`.
- Added option to annotate and highlight special proteins in 
  `plot.expression_comparison()` by using the `special_proteins` argument.
- Added option to annotate and highlight special proteins in `plot.volcano_ma()` by
  using the `special_proteins` argument.
- Added option to specify which experiments are used in `plot.experiment_ratios()` by
  using the `experiments` argument.

### Changed
- Decreased the transparency of the density distributions in `plot.experiment_ratios()`
  and `plot.replicate_ratios()`.
- The first subplot from `plot.experiment_ratios()` now displays the number of data
  points used for generating the distribution as "n = xxxx".
- Overlapping replicate annotations in `plot.sample_pca()` are now automatically
  adjusted.
- Added the python package "adjustText" to the msreport requirements.
- Added missing docstring descriptions.
- Removed return value from `analyze.calculate_two_group_limma()`
- Switched from `setup.py` to `pyproject.toml` for specifying build instructions and
  package meta data.

### Fixes
- Fixed `plot.replicate_ratios()` displaying no or too few gridlines.
- Fixed `plot.contaminants()` y-axis label not being adjusted to the specified tag.
- Fixed wrong p-value calculation of multi group LIMMA when the sample order in
  `qtable.data` and `qtable.design` was different.
- Corrected wrong type hints for arguments and return values.
- Corrected docstring typos.

----------------------------------------------------------------------------------------

## 0.0.6 - Minor API changes, small extensions and bug fixes

### Added
- Qtable.data is now always initiliazed with a "Valid" column with all rows being True.
- `rinterface.package_version()` to return the version of an installed R package
- Add `plot.expression_clustermap()` for plotting sample expession values as a
  hierarchically-clustered heatmap.
- Added two additional arguments for `analyze.add_protein_annotation()`
  - `molecular_weight` and `protein_name`

### Changed
- (!) Renamed MQReader to MaxQuantReader
- (!) Renamed FPReader to FragPipeReader
- The `rename_columns` argument in MaxQuantReader now renames additional columns:
  - "Intensity" to "Intensity combined"
  - "iBAQ" to "iBAQ intensity combined"
  - "Protein length" to "Molecular weight [kDA]"
- The `rename_columns` argument in FragPipeReader now renames additional columns:
  - "Description" to "Protein name"
  - "Gene" to "Gene name"
  - "Protein Length" to "Protein length"
  - "Entry Name" to "Protein entry name"
- Renamed the group comparison column tag "logFC" to "Ratio [log2]". This affects the
  output of the following functions:
  - `analyze.two_group_comparison()`
  - `analyze.calculate_multi_group_limma()`
  - `analyze.calculate_two_group_limma()`
- `analyze.add_protein_annotation()` now returns -1 for missing "Protein length" and
  "iBAQ peptides" entries.
- "Total" and "Combined", and their lower case variants, are ignored as samples names
  when using `guess_design()`.
- When using `qtable.set_expression_by_tag()`, only sample names present in the design
  are considered. In addition.
- When setting expression columns for a qtable instance, the exact samples present in
  the design table must be present in the expression columns.
- Renamed outdated XlsxReport config file for LFQ protein reports from
  "qtable_proteins.yaml" to "msreport_lfq_protein.yaml"
- Removed maspy dependency

### Fixes
- Calling `reader.add_sequence_coverage()` with protein length as float instead of
  integer values does no longer raise an error.
- The replicate labels in `plot.replicate_ratios()` and `plot.sample_pca()` were
  previously extracted from sample names. Now they are read from the qtable.design.

----------------------------------------------------------------------------------------

## 0.0.5 - Overhaul sorting of leading proteins

- Reader module
  - Leading proteins are no longer sorted during the protein import. Protein sorting is
    now done by a dedicated function, `reader.sort_leading_proteins`.
  - Added `reader.sort_leading_proteins`, which allows sorting of leading proteins with
    four options: Alphanumeric sorting by protein ID, penalization of contaminants,
    promotion of special proteins, and sorting of protein entries by the database from
    which the entry originates.
  - Added `reader.add_protein_annotation`, which allows adding protein annotations from
    a protein database. Optional arguments allow to specify the added annotation
    columns.
  - Added `reader.add_leading_proteins_annotation`, which allows adding protein
    annotations for the "Leading proteins" column, i.e. multiple annotation per field,
    one for each protein ID. Uses the same syntax as `reader.add_protein_annotation` to
    specify the added annotation columns.

- Introduced breaking changes
  - Replaced `reader.add_protein_annotations` with `reader.add_protein_annotation`
  - `reader.add_peptide_positions`, now requires a protein database instead of a fasta
    path.

----------------------------------------------------------------------------------------

## 0.0.4 - Errors and Optional arguments

- Analyze module
  - Added several additional arguments to impute_missing_values(), which allow
    specifying a seed for the random number generator, performing imputation
    column wise or in total, specifying the median downshift and std width
    for calculation of the normal distribution parameters.

- Errors and warnings
  - Added errors module, containing msreport specific errors and warning
  - Added warning to reader.add_protein_annotations() and
    reader.add_peptide_positions() when proteins are absent from fasta files.
  - Added specific errors to the analyze and normalize modules.

- Normalize module
  - Normalizer classes got a get_fits() function to retrieve sample fits.

- Qtable module
  - Added indexing to the Qtable, which allows directly accessing and setting columns
    for qtable.data with [] by calling qtable[column_name].

- Reader module
  - Added arguments to add_protein_annotations() for specifying whether "Protein length"
    and "iBAQ peptides" should be added or not.

----------------------------------------------------------------------------------------

## 0.0.3 - Multi group limma and small extensions

- Reader module
  - Added function for converting peptide sites from the "Modifications" column
    to protein sites, and adding them to the "Protein modifications" column.

- Helper module
  - guess_design() now also extracts the replicate from sample names and returns
    a dataframe with the columns "Sample", "Experiment", "Replicate". If no
    experiment was extracted the sample name is used as experiment.

- Analyze module
  - Added function that allows calculating multi group differential expression
    analysis with limma and taking batch effects into account.

- Plot module
  - Specifying a different "pvalue_tag" in volcano_ma() now allows plotting of
    the "Adjusted p-value" instead of the "P-value".

- Qtable module
  - Added get_data() function to qtable, which returns a copy of qtable.data and
    allows exclusion of invalid values.

- Fixes
  - Parsing of incomplete or non-standard FASTA headers should be possible now.
  - Fixed inconsistent y-axis labelling of plots generated with
    plot.expression_comparison().
  - Fixed issue with exported amica tables being incompatible with amica.

----------------------------------------------------------------------------------------

## 0.0.2 - Extended plotting and import functionality

- Plot module
  - Plot for Comparing expression values between replicates of each experiments.
  - volcano_ma() now requires specifying the experiment pair that will be compared.

- Reader module
  - Added support for importing peptide tables to MQReader and FPReader
  - Added support for importing ion tables to MQReader and FPReader. Importing ion
    tables adds a "Modifications" column and changes entries in the "Modified sequence"
    column to comply with the MsRepport conventions. 
  - Changed the behaviour of 'drop_decoy' and 'drop_idbysite' when importing files
    using the MQReader, which now also removes the "Reverse" and "Only identified by
    site" columns from the table.

- MsReport scripts
  - Added a benchmark plotting script that allows comparing ground truth data sets
    analyzed with different software, settings or methods.
  - Added a excel protein report script that uses the XlsxReport library to write a
    formatted excel protein report from a Qtable.

----------------------------------------------------------------------------------------

## 0.0.1 - initial release

- Initial unstable release of MsReport

- Reader module
  - Fully implemented import of protein tables from MaxQuant and FragPipe.
  - Partially implemented import of peptide and ion tables from FragPipe.
  - Update peptide table with protein start and end positions from a FASTA file.
  - Update protein table with protein annotations from a FASTA file.
  - Update protein table with sequence coverage, using information from a peptide table.
  - Update protein table with iBAQ intensities. 

- Qtable class
  - Allows retrieving information from the experimental design, like sample names.
    associated with an experiment or the experiment associated with a sample name.
  - Allows setting a group of quantification columns to be used as expression columns,
    which are then automatically used for subsequent analysis.
  - Generate a new dataframe, only containing the expression columns.
  - Export data to a tab separated file or to the clipboard.

- Analyze module
  - Analyze missing values and quantified replicates per experiment and in total.
  - Validate proteins according to the number of identified peptides and quantified
    replicates.
  - Normalize expression values between samples.
  - Impute missing expression values by sampling from a gaussian distribution.
  - Calculate mean experiment expression values.
  - Calculate log fold change and average expression values of two experiments.
  - Analyze differential expression between experiments by using LIMMA.

- Plot module
  - Display relative abundance of all contaminants per sample.
  - Analyze completeness of quantification per experiment.
  - Compare similarity of raw intensities between samples.
  - Compare similarity of expression values between all experiments.
  - Analyze sample similarity with a PCA plot.
  - Compare expression values between two experiments.
  - Compare two experiments with a volcano and MA plot.

- Export module
  - Generate a contaminant table.
  - Export data from a Qtable to the Amica input format. 

- Normalize module
  - Provides several normalizer classes that can be fitted with expression data from
    multiple samples and then be used to apply the fitting to quantitative data.
  - Fixed value normalizer with median or mode.
  - Value dependent normalizer with LOWESS.

- Rinterface module
  - Provides an interface to call R code from python and automatically install required
    packages from CRAN and Bioconductor.
  - Two experiment differential expression analysis by using LIMMA.